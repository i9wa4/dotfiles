#!/usr/bin/env bash
set -o errexit
set -o nounset
set -o pipefail
set -o posix

print_usage() {
  cat <<'EOF'
Usage:
  mkoutput --dir DIR --label LABEL

Creates:
  $XDG_STATE_HOME/mkoutput/<owner>-<repo>/YYYY-MM-DD-<branch>/<DIR>/<LABEL>-<ID>.md
  Works in git repos (uses owner/repo from ghq path) and outside git (uses "local"/dirname).

Options:
  --dir DIR    Directory name under the daily session
  --label LABEL File label included in the filename
  -h, --help   Show this help and exit
EOF
}

# Defaults
LABEL=""
DIR=""

# Parse arguments
while [[ $# -gt 0 ]]; do
  case $1 in
    -h | --help)
      print_usage
      exit 0
      ;;
    --dir)
      DIR="$2"
      shift 2
      ;;
    --label)
      LABEL="$2"
      shift 2
      ;;
    -*)
      echo "Unknown option: $1" >&2
      exit 1
      ;;
    *)
      echo "Error: Unknown argument: $1" >&2
      exit 1
      ;;
  esac
done

# Validate DIR and LABEL
if [[ -z $DIR || -z $LABEL ]]; then
  echo "Error: --dir and --label are required" >&2
  print_usage >&2
  exit 1
fi

# Resolve project identity and branch
repo_root="$(git rev-parse --show-toplevel 2>/dev/null || true)"

if [[ -n $repo_root ]]; then
  # Inside a git repository
  ghq_root=""
  if command -v ghq &>/dev/null; then
    ghq_root="$(ghq root 2>/dev/null || true)"
  fi
  if [[ -z $ghq_root ]]; then
    ghq_root="$HOME/ghq"
  fi

  ghq_prefix="${ghq_root}/github.com/"

  # Resolve main repo root (handles git worktrees)
  git_common_dir="$(git rev-parse --git-common-dir 2>/dev/null || true)"
  if [[ -n $git_common_dir && $git_common_dir != ".git" && $git_common_dir != ".git/" ]]; then
    # Linked worktree: git_common_dir is absolute path to main repo's .git
    main_repo_root="${git_common_dir%/.git}"
  else
    main_repo_root="$repo_root"
  fi

  if [[ $main_repo_root == "${ghq_prefix}"* ]]; then
    ghq_rel="${main_repo_root#"${ghq_prefix}"}"
    project_owner="${ghq_rel%%/*}"
    project_name="${ghq_rel#*/}"
    project_name="${project_name%%/*}"
  else
    project_owner="local"
    project_name="$(basename "$main_repo_root")"
  fi

  branch_name="$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo unknown)"
  branch_name="${branch_name//\//-}"
else
  # Outside a git repository: use current directory name
  project_owner="local"
  project_name="$(basename "$(pwd -P)")"
  branch_name="local"
fi
date_dir="$(date +%Y-%m-%d)-${branch_name}"
state_home="${XDG_STATE_HOME:-$HOME/.local/state}"
TARGET_DIR="${state_home}/mkoutput/${project_owner}-${project_name}/${date_dir}/${DIR}"

# Generate filename
ID=$(printf '%04x' $RANDOM)
FILE_NAME="${LABEL}-${ID}.md"
FILE_PATH="$TARGET_DIR/$FILE_NAME"

# Create directory and file
mkdir -p "$TARGET_DIR"
touch "$FILE_PATH"

# Output the created file path
echo "$FILE_PATH"
echo "Created: $FILE_PATH" >&2
