#!/usr/bin/env bash
set -o errexit
set -o nounset
set -o pipefail
set -o posix

# Remove git worktree(s) by ghq repository path.
# Safely removes only worktrees (not regular repositories).
#
# Usage:
#   worktree-remove <ghq_repo_path> [ghq_repo_path2 ...]
#
# Example:
#   worktree-remove github.com/org/project-issue-123
#
# Dependencies:
#   - ghq

# Check arguments
if [[ $# -eq 0 ]]; then
  echo "Usage: $0 <ghq_repo_path> [ghq_repo_path2 ...]" >&2
  echo "Example: $0 github.com/org/project-issue-123" >&2
  exit 1
fi

# Get ghq root directory
ghq_root=$(ghq root)

# Process each repository
for repo in "$@"; do
  repo_path="${ghq_root}/${repo}"

  echo "Processing: ${repo}"

  # Check if directory exists
  if [[ ! -d $repo_path ]]; then
    echo "  Warning: Directory does not exist: ${repo_path}" >&2
    continue
  fi

  # Check if it's a worktree (.git is a file, not a directory)
  if [[ -f "${repo_path}/.git" ]]; then
    echo "  -> Removing worktree..."

    # Extract main repository path from .git file
    main_repo=$(grep "gitdir:" "${repo_path}/.git" | sed 's/gitdir: //' | sed 's|/.git/worktrees/.*||')

    # Run git worktree remove from main repository
    cd "${main_repo}" && git worktree remove --force "${repo_path}"
    echo "  * Removed: ${repo_path}"
  else
    echo "  Warning: Not a worktree (regular repository): ${repo_path}" >&2
  fi

  echo ""
done

echo "* Done."
