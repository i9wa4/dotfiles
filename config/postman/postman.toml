# Postman Configuration
# File-based communication daemon for tmux panes

# =============================================================================
# Template Variables Reference
# =============================================================================
#
# notification_template:
#   {from_node}      - Sender node name
#   {node}           - Recipient node name
#   {timestamp}      - Message timestamp (YYYYMMDD-HHMMSS)
#   {inbox_path}     - Full path to recipient's inbox directory
#   {filename}       - Message filename
#   {talks_to_line}  - Formatted list of nodes this node can communicate with
#   {template}       - Node's role template (from [node].template)
#   {reply_command}  - Command to create draft message
#   {context_id}     - Current session context ID
#   {session_dir}    - Session directory path
#
# ping_template:
#   {context_id}     - Current session context ID
#   {node}           - Target node name
#   {timestamp}      - Message timestamp (YYYYMMDD-HHMMSS)
#   {from_node}      - Sender node name (always "postman")
#   {template}       - Node's role template
#   {talks_to_line}  - Formatted list of nodes this node can communicate with
#   {active_nodes}   - Comma-separated list of all active nodes
#   {reply_command}  - Command to create draft message
#   {session_dir}    - Session directory path
#
# digest_template:
#   {digest_items}   - Formatted list of new messages
#
# draft_template:
#   {context_id}     - Current session context ID
#   {task_id}        - Unique task identifier
#   {sender}         - Sender node name
#   {recipient}      - Recipient node name
#   {timestamp}      - ISO format timestamp
#   {from}           - Alias for {sender} (backward compatibility)
#   {to}             - Alias for {recipient} (backward compatibility)
#
# common_template:
#   Shared template string prepended to all node templates.
#   Applied in ping and notification contexts. Not applied to digest or draft.
#
# =============================================================================

[postman]
a2a_version = "1.0"
startup_delay_seconds = 10
new_node_ping_delay_seconds = 3  # Delay before sending ping to newly joined nodes
reminder_interval_seconds = 20  # Send reminder after N messages (0 = disabled)

# Timing settings
scan_interval_seconds = 1  # Pane rescan interval in seconds
tmux_timeout_seconds = 30  # Timeout for tmux commands
enter_delay_seconds = 0.7  # Delay before sending Enter key

edges = [
  "watchdog -- concierge",
  "concierge -- orchestrator",
  "orchestrator -- worker",
  "orchestrator -- observer-a-leader",
  "orchestrator -- observer-b-leader",
  "observer-a-leader -- observer-claude-1",
  "observer-a-leader -- observer-claude-2",
  "observer-b-leader -- observer-codex-1",
  "observer-b-leader -- observer-codex-2",
]

# common_template: Shared template prepended to all node templates (default: "")
# common_template = ""

# Optional settings (using defaults):
# edge_activity_seconds = 60.0  # TUI edge glow duration (1-3600)
# base_dir = ""                 # Override session dir (default: XDG_STATE_HOME/postman)
# ui_node = "concierge"         # TUI target node for watchdog alerts

# Reminder message (sent periodically to nodes)
reminder_message = """
$(cat ~/ghq/github.com/i9wa4/dotfiles/config/claude/CLAUDE.md)
"""

# Reply instruction (used in templates)
reply_command = "~/ghq/github.com/i9wa4/tmux-a2a-postman/tmux-a2a-postman create-draft --context-id {context_id} --to <recipient>"

# Notification template (when new message arrives)
notification_template = """
<!-- message start -->
{template}

{talks_to_line}

## Message Details

ðŸ“¬ Message from {from_node}

After reading, move from inbox/ to read/

- File: {filename}
- inbox path: {inbox_path}
- read path: {session_dir}/read/

## Reply (if needed)

NEVER create draft manually. Always:

1. {reply_command}
2. Edit content
3. mv from draft/ to post/
  - draft path: {session_dir}/draft/
  - post path: {session_dir}/post/
<!-- end of message -->
"""

# Ping message template
ping_template = """
<!-- message start -->
{template}

{talks_to_line}

## Message Details

ðŸ“¬ Message from {from_node}

After reading, move from inbox/ to read/

- read path: {session_dir}/read/

## Reply

You MUST reply with PONG to confirm you are active.

1. {reply_command}
2. Edit content
3. mv from draft/ to post/
  - draft path: {session_dir}/draft/
  - post path: {session_dir}/post/
<!-- end of message -->
"""

# Observer digest template
digest_template = """
<!-- message start -->
ðŸ“‹ Carbon Copy: New messages.

You MUST Review message contents and code changes. If you feel any issues, report to relevant nodes.

{digest_items}
<!-- end of message -->
"""

# Draft message template
draft_template = """---
method: message/send
params:
  contextId: {context_id}
  taskId: {task_id}
  from: {sender}
  to: {recipient}
  timestamp: {timestamp}
---

## Content

"""

[watchdog]
enabled = true
idle_threshold_seconds = 300.0  # 5 minutes
cooldown_seconds = 600.0  # 10 minutes
heartbeat_interval_seconds = 60.0  # 1 minute

[watchdog.capture]
enabled = true
tail_lines = 100
max_files = 10
max_bytes = 1048576  # 1MB

[watchdog.lock]
path = "$HOME/.postman/postman-watchdog.lock"

[concierge]
role = "user interface, clarification"
on_join = ""
template = """
# CONCIERGE (READONLY)

- User's interface - receive requests and clarify requirements
- YOU MUST: Delegate to orchestrator for anything
"""

[orchestrator]
role = "coordination, delegation"
on_join = "I'm postman. You are the /orchestrator !"
template = """
# ORCHESTRATOR (READONLY)

- Delegate tasks to workers (NEVER Edit/Write directly)
- YOU MUST: Consult all observers for anything

## Observer Response Escalation

When you send requests to multiple nodes:
- Track who has responded and who has not
- When some nodes remains silent, immediately send an URGENT follow-up to the non-responders
- The URGENT message MUST state:
  - How many others have already responded
  - That the project is blocked waiting for their response
  - A direct demand to respond immediately
- NEVER wait passively - one non-responder must not block the entire team
- If still no response after URGENT follow-up, proceed with available responses and note the absence in the report
"""

[worker]
role = "implementation, consultation"
on_join = ""
template = """
# WORKER (WRITABLE)

- Execute assigned tasks
- Report issues to observer

## Expected Feedback Format from Observers

When observers provide feedback, they should classify findings by severity:

- **BLOCKING**: Must be fixed before commit (security issues, critical bugs, broken tests)
- **IMPORTANT**: Should be addressed soon (design flaws, missing error handling, maintainability concerns)
- **MINOR**: Future improvement candidates (performance optimization ideas, code style suggestions)
"""

[observer-a-leader]
role = "active-monitoring, proactive-review"
observes = ["orchestrator"]
on_join = ""
template = """
# OBSERVER-LEADER (ACTIVE MONITORING)

MANDATORY: Process digest on arrival
- Analyze message content for design flaws, bugs, edge cases, security concerns
- Classify findings: BLOCKING (critical), IMPORTANT (should fix), MINOR (improve)
- Coordinate with team members if you have members
- Send analysis report to orchestrator
- If no issues: Send "Status: All clear" confirmation

Actions:
1. Upon digest arrival: MUST analyze (not ignore)
2. Send discussion request to team members
3. Collect feedback within 1 hour
4. Report to orchestrator with specific recommendations
"""

[observer-claude-1]
role = "monitoring, review"
on_join = ""
template = """
# OBSERVER (READONLY)

- Monitor and review all activities
- Report concerns to relevant nodes
"""

[observer-claude-2]
role = "monitoring, review"
on_join = ""
template = """
# OBSERVER (READONLY)

- Monitor and review all activities
- Report concerns to relevant nodes
"""

[observer-b-leader]
role = "active-monitoring, proactive-review"
observes = ["orchestrator"]
on_join = ""
template = """
# OBSERVER-LEADER (ACTIVE MONITORING)

MANDATORY: Process digest on arrival
- Analyze message content for design flaws, bugs, edge cases, security concerns
- Classify findings: BLOCKING (critical), IMPORTANT (should fix), MINOR (improve)
- Coordinate with team members if you have members
- Send analysis report to orchestrator
- If no issues: Send "Status: All clear" confirmation

Actions:
1. Upon digest arrival: MUST analyze (not ignore)
2. Send discussion request to team members
3. Collect feedback within 1 hour
4. Report to orchestrator with specific recommendations
"""

[observer-codex-1]
role = "monitoring, review"
on_join = ""
template = """
# OBSERVER (READONLY)

- Monitor and review all activities
- Report concerns to relevant nodes
"""

[observer-codex-2]
role = "monitoring, review"
on_join = ""
template = """
# OBSERVER (READONLY)

- Monitor and review all activities
- Report concerns to relevant nodes
"""
