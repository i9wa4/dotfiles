# Postman Configuration
# File-based communication daemon for tmux panes

# =============================================================================
# Template Variables Reference
# =============================================================================
#
# notification_template:
#   {from_node}      - Sender node name
#   {node}           - Recipient node name
#   {timestamp}      - Message timestamp (YYYYMMDD-HHMMSS)
#   {inbox_path}     - Full path to recipient's inbox directory
#   {filename}       - Message filename
#   {talks_to_line}  - Formatted list of nodes this node can communicate with
#   {template}       - Node's role template (from [node].template)
#   {reply_command}  - Command to create draft message
#   {context_id}     - Current session context ID
#   {session_dir}    - Session directory path
#
# ping_template:
#   {context_id}     - Current session context ID
#   {node}           - Target node name
#   {timestamp}      - Message timestamp (YYYYMMDD-HHMMSS)
#   {from_node}      - Sender node name (always "postman")
#   {template}       - Node's role template
#   {talks_to_line}  - Formatted list of nodes this node can communicate with
#   {active_nodes}   - Comma-separated list of all active nodes
#   {reply_command}  - Command to create draft message
#   {inbox_path}     - Full path to recipient's inbox directory
#   {session_dir}    - Session directory path
#
# digest_template:
#   {digest_items}   - Formatted list of new messages
#
# draft_template:
#   {context_id}     - Current session context ID
#   {task_id}        - Unique task identifier
#   {sender}         - Sender node name
#   {recipient}      - Recipient node name
#   {timestamp}      - ISO format timestamp
#   {from}           - Alias for {sender} (backward compatibility)
#   {to}             - Alias for {recipient} (backward compatibility)
#
# common_template:
#   Shared template string prepended to all node templates.
#   Applied in ping and notification contexts. Not applied to digest or draft.
#
# =============================================================================

[postman]
a2a_version = "1.0"
startup_delay_seconds = 10
new_node_ping_delay_seconds = 3  # Delay before sending ping to newly joined nodes
reminder_interval_seconds = 20  # Send reminder after N messages (0 = disabled)

# Timing settings
scan_interval_seconds = 1  # Pane rescan interval in seconds
tmux_timeout_seconds = 30  # Timeout for tmux commands
enter_delay_seconds = 3.0  # Delay before sending Enter key

# Pane capture settings (hybrid idle detection)
pane_capture_interval_seconds = 10.0

edges = [
  "boss -- orchestrator",
  "messenger -- orchestrator",
  "orchestrator -- worker",
  "orchestrator -- critic",
  "orchestrator -- guardian",
  "critic -- guardian",
]

# common_template: Shared template prepended to all node templates (default: "")
# common_template = ""

# Optional settings (using defaults):
# edge_activity_seconds = 60.0  # TUI edge glow duration (1-3600)
# base_dir = ""                 # Override session dir (default: XDG_STATE_HOME/postman)
ui_node = "messenger"         # TUI target node for watchdog alerts

# Reminder message (sent periodically to nodes)
reminder_message = """
$(cat ~/.agents/AGENTS.md)
"""

# Reply instruction (used in templates)
reply_command = "nix run github:i9wa4/tmux-a2a-postman -- create-draft --context-id {context_id} --to <recipient>"

# Notification template (when new message arrives)
notification_template = """
<!-- message start -->
{template}

{talks_to_line}

## Message Details

ðŸ“¬ Message from {from_node}

After reading, move from inbox/ to read/

- File: {filename}
- inbox path: {inbox_path}
- read path: {session_dir}/read/

## Reply (if needed)

NEVER create draft manually. Always:

1. {reply_command}
2. Edit content
3. Move from draft/ to post/
  - draft path: {session_dir}/draft/
  - post path: {session_dir}/post/
<!-- end of message -->
"""

# Ping message template
ping_template = """
<!-- message start -->
{template}

{talks_to_line}

## Message Details

ðŸ“¬ Message from {from_node}

After reading, move from inbox/ to read/

- inbox path: {inbox_path}
- read path: {session_dir}/read/

## Reply

You MUST reply with PONG to confirm you are active.
If you do not respond, you will be treated as DROPPED (inactive).

Steps:

1. {reply_command}
   - Replace `<recipient>` with `postman`
2. In the Content section, write only: PONG
3. Move from draft/ to post/
  - draft path: {session_dir}/draft/
  - post path: {session_dir}/post/
<!-- end of message -->
"""

# Draft message template
draft_template = """---
method: message/send
params:
  contextId: {context_id}
  taskId: {task_id}
  from: {sender}
  to: {recipient}
  timestamp: {timestamp}
---

## Content

"""

[watchdog]
enabled = true
idle_threshold_seconds = 300.0  # 5 minutes
cooldown_seconds = 600.0  # 10 minutes
heartbeat_interval_seconds = 60.0  # 1 minute

[watchdog.capture]
enabled = true
tail_lines = 100
max_files = 10
max_bytes = 1048576  # 1MB

[watchdog.lock]
path = "$HOME/.postman/postman-watchdog.lock"
