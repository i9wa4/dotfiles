#!/usr/bin/env bash
set -o errexit
set -o nounset
set -o pipefail
set -o posix

# 引数チェック
if [[ $# -eq 0 ]]; then
  echo "Usage: $0 <issue_number> [issue_number2 ...]" >&2
  echo "Example: $0 123" >&2
  echo "Example: $0 123 456 789" >&2
  exit 1
fi

# 基本設定
repo_name=$(basename "$(git rev-parse --show-toplevel)")

# リモート情報を一度だけ取得
echo "→ リモート情報を取得中..."
git fetch origin
echo ""

# 各 Issue 番号に対して処理
for issue_number in "$@"; do
  # 番号の妥当性チェック
  if [[ ! $issue_number =~ ^[0-9]+$ ]]; then
    echo "Warning: '$issue_number' は無効な Issue 番号です。スキップします。" >&2
    echo ""
    continue
  fi

  echo "=== Issue #${issue_number} の処理開始 ==="

  # Issue 情報を取得してブランチ名のスラッグを生成
  echo "→ Issue 情報を取得中..."
  issue_json=$(gh issue view "${issue_number}" --json title,body,comments 2>/dev/null || echo "{}")
  issue_title=$(jq -r '.title // empty' <<< "$issue_json" 2>/dev/null || echo "")
  issue_body=$(jq -r '.body // empty' <<< "$issue_json" 2>/dev/null || echo "")
  issue_comments=$(jq -r '.comments[]?.body // empty' <<< "$issue_json" 2>/dev/null | head -c 2000 || echo "")

  if [[ -n $issue_title ]]; then
    echo "→ ブランチ名を生成中..."
    branch_slug=$(claude --print "以下のIssue情報から、Gitブランチ名として適切な英語の短いスラッグ(kebab-case)を生成してください。
- 最大5単語程度
- 小文字とハイフンのみ使用
- 特殊文字は除去
- 動詞から始めることを推奨

出力は英語のスラッグのみを返してください(説明不要)。

---
Issueタイトル: ${issue_title}
---
Issue本文:
${issue_body}
---
Issueコメント:
${issue_comments}
---" 2>/dev/null | tr -d '\n' || echo "")

    if [[ -n $branch_slug ]]; then
      branch_name="issue-${issue_number}-${branch_slug}"
      echo "✓ ブランチ名: ${branch_name}"
    else
      branch_name="issue-${issue_number}"
      echo "Warning: スラッグ生成に失敗しました。デフォルトのブランチ名を使用します: ${branch_name}"
    fi
  else
    branch_name="issue-${issue_number}"
    echo "Warning: Issue タイトルの取得に失敗しました。デフォルトのブランチ名を使用します: ${branch_name}"
  fi

  worktree_path="$(dirname "$(pwd)")/${repo_name}-${branch_name}"

  # 既存worktreeチェック
  if [[ -d $worktree_path ]]; then
    echo "✓ 既存のworktreeが存在: ${worktree_path}"
    echo "✓ ブランチ: ${branch_name}"
  else
    # worktree作成
    if git show-ref --verify --quiet "refs/remotes/origin/${branch_name}"; then
      git worktree add "$worktree_path" "$branch_name"
      echo "✓ worktreeを作成: ${worktree_path}"
    else
      git worktree add -b "$branch_name" "$worktree_path"
      echo "✓ worktreeを作成: ${worktree_path}"
      echo "✓ ローカルブランチを作成: ${branch_name}"
    fi

    # repo-setup を実行
    echo "→ repo-setup を実行中..."
    cd "$worktree_path"
    if command -v repo-setup &>/dev/null; then
      repo-setup
    else
      echo "Warning: repo-setup コマンドが見つかりません。手動でセットアップしてください。"
    fi
    cd - >/dev/null
  fi

  echo ""
done

echo "✓ すべての Issue 対応環境の準備が完了しました"
echo ""
