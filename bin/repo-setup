#!/usr/bin/env bash
set -o errexit
set -o nounset
set -o pipefail
set -o posix

# Set up repository environment for development.
# Creates local.vim, .i9wa4/ directory, and trusts mise.toml.
# Also runs repository-specific setup based on repo name.
#
# Usage:
#   repo-setup
#
# Created files:
#   - local.vim: Vim local configuration
#   - .i9wa4/: Working directory (gitignored globally)
#   - .i9wa4/temp.md: Template file for notes

# Get main repository info (works from worktree too)
main_repo="$(git worktree list --porcelain | awk '/^worktree / {print $2; exit}')"
repo_name="$(basename "${main_repo}")"
echo "* Repository: ${repo_name}"

# Create local.vim
cat >local.vim <<'EOF'
" ~/ghq/github.com/i9wa4/dotfiles/config/vim/rc/local.default.vim
let g:mnh_header_level_shift = 1
let g:my_tp_path = '.i9wa4/temp.md'->expand()
EOF
echo "* Created local.vim"

# Create .i9wa4/ directory (subdirectories created on demand by touchfile.sh)
mkdir -p .i9wa4/{plans,reviews,tmp}
echo "* Created .i9wa4/ directory"

# Create template file
cat >.i9wa4/temp.md <<'EOF'
# temp
EOF

# Trust mise.toml if exists
if [[ -f "mise.toml" ]]; then
  mise trust mise.toml
  echo "* Trusted mise.toml"
fi

# Repository-specific setup
case "${repo_name}" in
  # Example: frontend project
  "my-frontend-app")
    npm ci
    echo "* Installed npm dependencies"
    ;;
  # Example: backend project with .env
  "my-backend-api")
    if [[ -f "${main_repo}/.env" ]] && [[ ! -f .env ]]; then
      cp "${main_repo}/.env" .env
      echo "* Copied .env from main repository"
    fi
    ;;
  *)
    # No repository-specific setup
    ;;
esac

# Reset .mcp.json
rm -f .mcp.json

# https://github.com/korotovsky/slack-mcp-server
claude mcp add --scope project context7 -- npx -y @upstash/context7-mcp
claude mcp add --scope project awslabs-aws-documentation-mcp-server -- uvx awslabs.aws-documentation-mcp-server@latest

echo "* Setup complete"
