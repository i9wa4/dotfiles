# Postman Configuration
# File-based communication daemon for tmux panes

# =============================================================================
# Template Variables Reference
# =============================================================================
#
# notification_template:
#   {from_node}      - Sender node name
#   {node}           - Recipient node name
#   {timestamp}      - Message timestamp (YYYYMMDD-HHMMSS)
#   {inbox_path}     - Full path to recipient's inbox directory
#   {filename}       - Message filename
#   {talks_to_line}  - Formatted list of nodes this node can communicate with
#   {template}       - Node's role template (from [node].template)
#   {reply_command}  - Command to create draft message
#   {context_id}     - Current session context ID
#
# ping_template:
#   {context_id}     - Current session context ID
#   {node}           - Target node name
#   {timestamp}      - Message timestamp (YYYYMMDD-HHMMSS)
#   {from_node}      - Sender node name (always "postman")
#   {template}       - Node's role template
#   {talks_to_line}  - Formatted list of nodes this node can communicate with
#   {active_nodes}   - Comma-separated list of all active nodes
#   {reply_command}  - Command to create draft message
#
# digest_template:
#   {digest_items}   - Formatted list of new messages
#
# draft_template:
#   {context_id}     - Current session context ID
#   {task_id}        - Unique task identifier
#   {msg_id}         - Alias for task_id (backward compatibility)
#   {sender}         - Sender node name
#   {recipient}      - Recipient node name
#   {timestamp}      - ISO format timestamp
#
# =============================================================================

[postman]
a2a_version = "1.0"
base_dir = ".postman"  # Directory structure: {base_dir}/{context_id}/post/, inbox/, etc.
startup_delay_seconds = 10
new_node_ping_delay_seconds = 3  # Delay before sending ping to newly joined nodes
reminder_interval_seconds = 20  # Send reminder after N messages (0 = disabled)

# Timing settings
scan_interval_seconds = 1  # Pane rescan interval in seconds
tmux_timeout_seconds = 30  # Timeout for tmux commands
enter_delay_seconds = 0.7  # Delay before sending Enter key

edges = [
  "concierge --> orchestrator --> worker",
  "orchestrator --> observer-a-leader",
  "orchestrator --> observer-b-leader",
  "observer-a-leader --> observer-claude-1",
  "observer-a-leader --> observer-claude-2",
  "observer-b-leader --> observer-codex-1",
  "observer-b-leader --> observer-codex-2",
]

# Reminder message (sent periodically to nodes)
reminder_message = """
$(cat ~/ghq/github.com/i9wa4/dotfiles/config/claude/CLAUDE.md)
"""

# Reply instruction (used in templates)
reply_command = "uv run ~/ghq/github.com/i9wa4/dotfiles/bin/postman.py create-draft --to <recipient>"

# Notification template (when new message arrives)
notification_template = """
ðŸ“¬ Message from {from_node}

After reading, move from inbox/ to read/

{template}

{talks_to_line}

## Message Details

Inbox: {inbox_path}/
File: {filename}

## Reply (if needed)

NEVER create draft manually. Always:

1. {reply_command}
2. Edit content
3. mv draft/ to post/
"""

# Ping message template
ping_template = """
ðŸ“¬ [PING] Status check

contextId: {context_id}
You MUST reply with PONG to confirm you are active.

You are: {node}

{template}

{talks_to_line}

## Reply

1. Create draft: {reply_command}
2. Post: `mv .postman/{context_id}/draft/xxx.md .postman/{context_id}/post/`
"""

# Observer digest template
digest_template = """
ðŸ“‹ Digest: New messages

Action: Review message contents and code changes. If you feel any issues, report to relevant nodes.

{digest_items}
"""

# Draft message template
draft_template = """---
method: message/send
params:
  contextId: {context_id}
  taskId: {task_id}
  from: {sender}
  to: {recipient}
  timestamp: {timestamp}
---

## Content

"""

[concierge]
role = "user interface, clarification"
on_join = "I'm postman. You are the concierge - user's interface!"
template = """
# CONCIERGE (READONLY)

- User's interface - receive requests and clarify requirements
- YOU MUST: Delegate to orchestrator for anything
"""

[orchestrator]
role = "coordination, delegation"
on_join = "I'm postman. You are the /orchestrator !"
template = """
# ORCHESTRATOR (READONLY)

- Delegate tasks to workers (NEVER Edit/Write directly)
- YOU MUST: Consult all observers for anything

## Observer Response Escalation

When you send requests to multiple nodes:
- Track who has responded and who has not
- When some nodes remains silent, immediately send an URGENT follow-up to the non-responders
- The URGENT message MUST state:
  - How many others have already responded
  - That the project is blocked waiting for their response
  - A direct demand to respond immediately
- NEVER wait passively - one non-responder must not block the entire team
- If still no response after URGENT follow-up, proceed with available responses and note the absence in the report
"""

[worker]
role = "implementation, consultation"
on_join = ""
template = """
# WORKER (WRITABLE)

- Execute assigned tasks
- Report issues to observer

## Expected Feedback Format from Observers

When observers provide feedback, they should classify findings by severity:

- **BLOCKING**: Must be fixed before commit (security issues, critical bugs, broken tests)
- **IMPORTANT**: Should be addressed soon (design flaws, missing error handling, maintainability concerns)
- **MINOR**: Future improvement candidates (performance optimization ideas, code style suggestions)
"""

[observer-a-leader]
role = "monitoring, review"
subscribe_digest = true
on_join = "I'm postman. You are observer-a-leader - LEAD OBSERVER. Your members: observer-claude-1, observer-claude-2. You MUST coordinate with them before responding to orchestrator."
template = """
# OBSERVER (READONLY)

- Monitor and review all activities
- Report concerns to relevant nodes
- You are the LEAD OBSERVER with members: observer-claude-1, observer-claude-2
- MANDATORY: Coordinate with ALL members before responding to orchestrator
- MANDATORY: Consult members on all review requests
"""

[observer-claude-1]
role = "monitoring, review"
on_join = ""
template = """
# OBSERVER (READONLY)

- Monitor and review all activities
- Report concerns to relevant nodes
"""

[observer-claude-2]
role = "monitoring, review"
on_join = ""
template = """
# OBSERVER (READONLY)

- Monitor and review all activities
- Report concerns to relevant nodes
"""

[observer-b-leader]
role = "monitoring, review"
subscribe_digest = true
on_join = "I'm postman. You are observer-b-leader - LEAD OBSERVER. Your members: observer-codex-1, observer-codex-2. You MUST coordinate with them before responding to orchestrator."
template = """
# OBSERVER (READONLY)

- Monitor and review all activities
- Report concerns to relevant nodes
- You are the LEAD OBSERVER with members: observer-codex-1, observer-codex-2
- MANDATORY: Coordinate with ALL members before responding to orchestrator
- MANDATORY: Consult members on all review requests
"""

[observer-codex-1]
role = "monitoring, review"
on_join = ""
template = """
# OBSERVER (READONLY)

- Monitor and review all activities
- Report concerns to relevant nodes
"""

[observer-codex-2]
role = "monitoring, review"
on_join = ""
template = """
# OBSERVER (READONLY)

- Monitor and review all activities
- Report concerns to relevant nodes
"""
