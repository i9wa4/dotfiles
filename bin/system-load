#!/usr/bin/env bash

# Display system load (CPU usage) for tmux status line.
#
# Usage:
#   system-load
#
# Output format:
#   CPU:XX%
#
# Supported platforms:
#   - macOS (Darwin)
#   - Linux

os_type=$(uname -s)

# Get total CPU usage percentage
get_total_cpu_usage() {
  case "${os_type}" in
  Darwin)
    # Parse top output for CPU usage (user + sys)
    top -l 1 -s 0 2>/dev/null | awk '/CPU usage/ {
        gsub(/%/, "", $3)
        gsub(/%/, "", $5)
        printf "%.0f", $3 + $5
      }'
    ;;
  Linux)
    # Parse /proc/stat for CPU usage
    read -r _cpu user nice system idle rest </proc/stat
    total1=$((user + nice + system + idle))
    idle1=${idle}
    sleep 0.1
    read -r _cpu user nice system idle rest </proc/stat
    total2=$((user + nice + system + idle))
    idle2=${idle}
    total_diff=$((total2 - total1))
    idle_diff=$((idle2 - idle1))
    if [ "${total_diff}" -gt 0 ]; then
      echo $(((total_diff - idle_diff) * 100 / total_diff))
    else
      echo "0"
    fi
    ;;
  *)
    echo "0"
    ;;
  esac
}

# Main
total_cpu=$(get_total_cpu_usage)

echo "CPU:${total_cpu}%"
