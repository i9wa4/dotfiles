#!/usr/bin/env bash
set -o errexit
set -o nounset
set -o pipefail
set -o posix

# Set up repository environment for development.
# Creates local.vim and trusts mise.toml.
# Also runs repository-specific setup based on repo name.
#
# Usage:
#   repo-setup
#
# Created files:
#   - local.vim: Vim local configuration
#   - $XDG_STATE_HOME/mkoutput/sessions/.../memo/memo-*.md: Daily memo file

# Get current worktree root
worktree_root="$(git rev-parse --show-toplevel 2>/dev/null || pwd -P)"
project_dir="$(basename "${worktree_root}")"
echo "* Repository: ${project_dir}"

# Create local.vim via CreateLocalVimrc
vimrc_path="$HOME/ghq/github.com/i9wa4/dotfiles/config/vim/vimrc"
if command -v vim &>/dev/null && [[ -f $vimrc_path ]]; then
  vim -Nu "$vimrc_path" -n -es +'CreateLocalVimrc' +qall
else
  cat >local.vim <<'EOF'
" ~/ghq/github.com/i9wa4/dotfiles/config/vim/rc/local.default.vim
let g:mnh_header_level_shift = 1
EOF
fi
echo "* Created local.vim"

# Create memo file via mkoutput
memo_path="$(mkoutput --dir memo --label memo)"
cat >"$memo_path" <<'EOF'
# temp
EOF
echo "* Memo:"
echo "${memo_path}"
tp_line="let g:my_tp_path = '${memo_path}'->expand()"
if grep -q '^let g:my_tp_path = ' local.vim; then
  tmp_file="$(mktemp)"
  awk -v line="$tp_line" '
    BEGIN { replaced = 0 }
    /^let g:my_tp_path = / {
      if (!replaced) {
        print line
        replaced = 1
      }
      next
    }
    { print }
    END { if (!replaced) print line }
  ' local.vim >"$tmp_file"
  mv "$tmp_file" local.vim
else
  printf '%s\n' "$tp_line" >>local.vim
fi

# Trust mise.toml if exists
if [[ -f "mise.toml" ]]; then
  mise trust mise.toml
  echo "* Trusted mise.toml"
fi

# Repository-specific setup
case "${project_dir}" in
  # Example: frontend project
  "my-frontend-app")
    npm ci
    echo "* Installed npm dependencies"
    ;;
  # Example: backend project with .env
  "my-backend-api")
    if [[ -f "${worktree_root}/.env" ]] && [[ ! -f .env ]]; then
      cp "${worktree_root}/.env" .env
      echo "* Copied .env from main repository"
    fi
    ;;
  *)
    # No repository-specific setup
    ;;
esac

# Reset .mcp.json
rm -f .mcp.json

# https://github.com/korotovsky/slack-mcp-server
# claude mcp add --scope project awslabs-aws-documentation-mcp-server -- uvx awslabs.aws-documentation-mcp-server@latest
# claude mcp add --scope project context7 -- npx -y @upstash/context7-mcp
# claude mcp add --scope project drawio -- npx @drawio/mcp

echo "* Setup complete"
